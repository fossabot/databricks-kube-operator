# databricks-kube-operator

A [kube-rs](https://kube.rs/) operator for the [Databricks Jobs 2.1 API](https://docs.databricks.com/dev-tools/api/latest/jobs.html).

## Getting Started

The quickest way to test the operator is with a working [minikube](https://minikube.sigs.k8s.io/docs/start/) cluster:

```bash
minikube start
minikube tunnel &
```

Generate and install the CRDs by running the `crd_gen` bin target:
```bash
cargo run --bin crd_gen | kubectl apply -f -
```

Create a config map in the same namespace as the operator:
```bash
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: ConfigMap
metadata:
  name: databricks-kube-operator
data:
  access_token: shhh
  databricks_url: https://my-tenant.cloud.databricks.com/api
EOF
```

```bash
export RUST_LOG=databricks_kube
cargo run
[2022-10-30T19:07:34Z INFO  databricks_kube] boot! (build: ed4c2ed-modified)
[2022-10-30T19:07:34Z INFO  databricks_kube::config] Waiting for CRD: databricksjobs.com.dstancu
```

## Generating the client

The client is generated by `openapi-generator` and then lightly postprocessed so we get models that derive [`JsonSchema`](https://github.com/GREsau/schemars#basic-usage) and fix some bugs.

TODO: Fork or fix generator/template issues instead of sed.

```bash
# Hey!! This uses GNU sed
# brew install gnu-sed
openapi-generator generate -g rust -i schema/jobs-2.1-aws.yaml -c schema/openapi-generator.yaml -o dbr

# Derive JsonSchema for all models and add schemars as dep
gsed -i -e 's/derive(Clone/derive(JsonSchema, Clone/' dbr/src/models/*
gsed -i -e 's/\/\*/use schemars::JsonSchema;\n\/\*/' dbr/src/models/*
gsed -r -i -e 's/(\[dependencies\])/\1\nschemars = "0.8.11"/' dbr/Cargo.toml

# Missing import?
gsed -r -i -e 's/(use reqwest;)/\1\nuse crate::models::ViewsToExport;/' dbr/src/apis/default_api.rs
```